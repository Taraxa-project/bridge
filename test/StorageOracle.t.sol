// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

import {Test, console} from "forge-std/Test.sol";
import {StorageOracle} from "../src/eth/StorageOracle.sol";
import {RLP} from "../src/lib/RLP.sol";
import "../src/lib/RLPEncode.sol";

contract StorageOracleTest is Test {
    StorageOracle oracle;
    address constant account = 0xdB7d6AB1f17c6b31909aE466702703dAEf9269Cf;
    bytes32 constant stateRoot = 0x328a4bffe51a6928b12fb0336a8aa64c534aa7331fc59bcbe304b4472ca02398;
    bytes32 constant accountRoot = 0x01122bba60ba8b736f28e7cb8ccd02a57b8262339fead30a3286c9c0bed346c8;

    function setUp() public {
        oracle = new StorageOracle();
    }

    function test_verifyAccount() public {
        bytes[] memory accountProof = new bytes[](2);
        accountProof[0] =
            hex"f8f1a0be4ffbff395be3f4bdab74fd7a725a903de036aac389cece64120ec0833922e1a09c30d8ff4300b132816e3fd00c81566f786d4e0f89210b98e0bed9fbceea3409a0d235f1cc8bef5e72a917432a09eaa01b155e90569ffd974de79edd63a3c9d8b38080a0a1840bf42c0dd67845195ef8d703229e61e412f61d4a423c097a2584b7770dc280a0265e21b4f091be24eed388d2d95faf81e61c6d6f01a24fdc9533052f34c50c5580a0c3692590e118c8fb5392261db94cc3ddcb4213306fd614e9d1ec26bf92778b66808080a08ab034387e108fb576ec8deaedf083652b28026063a2e2a1e0a34977005cc8a1808080";
        accountProof[1] =
            hex"f869a038f0847834712d0d4a56cc9fd09ca7a91cd58d022e0f3790ef365ae82a471419b846f8440180a001122bba60ba8b736f28e7cb8ccd02a57b8262339fead30a3286c9c0bed346c8a03bb6c927aa8d73f4be3c479e49a5357adc0ff448b5bfea109aaa067d29d6403b";

        oracle.processStorageRoot(account, stateRoot, RLPEncode.encodeBytesList(accountProof));
        assertEq(accountRoot, oracle.storageRoot(account));
    }

    function test_verifyAccountValue() public {
        test_verifyAccount();
        uint256 key = 0x7673bcbb3401a7cbae68f81d40eea2cf35afdaf7ecd016ebf3f02857fcc1260a;
        bytes32 v = 0x00000000000000000000000000000000000000000000000000000000000000c8;
        bytes[] memory storageProof = new bytes[](4);
        storageProof[0] =
            hex"f90211a0143fe733da764456df4e8156a29b342f0395cedebe6f90c9b97d3f47b330a07da0b6d9676841aecaf0140e64259abfe8f5c121fffb86c830d779a22445e20d5ddfa080fc9a9eb4df721c0a96fab15863936757eca601a6ffb6d613402f76523b80f3a0d2aac18e7ac07c668352efe46766207b97c11d4099640758b8602386e4d13a7da0e69ee300db64a6b0ddcaa137e20d22cde7699905b1eae6aaba07cf8438bd4f97a0b0fb54cb13ffb4641f8a442c020915d5bba6eb202af300a2a9b5752a93528d2da0474f0b6e1d71205a9fec7e912e0cf4f08a061c4cbee108e870a29c8118f7c0dfa06a4b3bd73e38d5df04916bb246d49ba04daaba2171ed534fadd75d0a29dd6798a0228c73aa594adbeede620329ee8cf48a37746645a784ed42566f5d0d8b525f3ca04fc19ec51f658891a94397efb32125b96196fd075dfd7c455a09d7dab0bd5bc5a0b5e66510ad58275a346354792c9edf47ec73c27042899905adf6534309335348a00aa9c67929df55ddb8edfc9476f6b3d29cb2e9a8930790b2c62b68f62becc8ffa0dc5c6aca57894e7c5c94142d4e461c9f9cb8fa214453597622689d7382f6f994a09d1a1b48475cf893c14100047779a04f3f4362b2152565f2fcd8c080696f8cb8a0eca6729a44aa835548bcb8412b18ece4a66c4ea6017765a6a4cdd63ab9648da2a07e5ffb40099efbafd3b94a89ac0d89988798c766231bb7b47bdfecf4a011aacf80";
        storageProof[1] =
            hex"f8f18080a0be6aba9ac1c6352f17e80656c7f0b3953ec8ce0e1f2cfb05ef769bfc37d1d77580a0b7b49995dce6c474becec567a6c96c93da7e0990598ac4dc1affbcd3ad452453a0694a30d09362cc00878eaeb2db522beb8d7c2e48a7e9732960f96d8778589e4780a09e9e038f1f2f81d0bb0e1f416f50de622e9fcecadb4197c5c2bdce5088c7aa2380a07100485452d5c384307581a6945a3fa16ffd690725485a5f9bc8aac1c7cac9fda0b07d81107063377c1c211957301caf7fa17445dcf151837d49ecc9bc64e7ff5980a0fb21b3c21a8b1068229c1e1380f327c83bffd17a6036c867839c6eb6552248b880808080";
        storageProof[2] =
            hex"f85180808080808080a0170d5e33d3b82bf6d5bf48a7894af46fcb1db73bd4c4a95016f368c5f3a96b93a092b46918d999f4142ff51b7b92831c3792050c9e7ead05742e798f42056730378080808080808080";
        storageProof[3] = hex"e39f34b3ead87fa915dbd1c2960185919de53b3c7f874e595264e401dc59d23ac08281c8";
        bytes32 value = oracle.getStorageValue(account, key, RLPEncode.encodeBytesList(storageProof));
        assertEq(v, value);
    }

    function test_verifyAccountMultiProof() public {
        test_verifyAccount();
        bytes memory accounts =
            hex"f8efe7a07673bcbb3401a7cbae68f81d40eea2cf35afdaf7ecd016ebf3f02857fcc1260a81c8c3808080e6a00bb0d0c2a399402027fb0eaada47a2c630983f3dd97f193c64f3e30465d04ec381c9c20180e6a07ec3c2f200843fc90126ba954586fc6de68c1a3d419d6f0667702fd695602f0581fac20280e7a046a4a9204e2252337cfce182401bbabede11720ab2d2e2330f66de6cfcb0b37982010ec20380e8a0d83db53d400092e1cd810411bbe8320db49f103fdcd91dec3d07ef7ac3dacd1e820119c3800180e7a0ef407a61ad059ad1a9edcba0919f1209387c016d49079cb4d982b420eb78a186820141c20480";
        bytes memory multiproof =
            hex"f908bab90214f90211a0143fe733da764456df4e8156a29b342f0395cedebe6f90c9b97d3f47b330a07da0b6d9676841aecaf0140e64259abfe8f5c121fffb86c830d779a22445e20d5ddfa080fc9a9eb4df721c0a96fab15863936757eca601a6ffb6d613402f76523b80f3a0d2aac18e7ac07c668352efe46766207b97c11d4099640758b8602386e4d13a7da0e69ee300db64a6b0ddcaa137e20d22cde7699905b1eae6aaba07cf8438bd4f97a0b0fb54cb13ffb4641f8a442c020915d5bba6eb202af300a2a9b5752a93528d2da0474f0b6e1d71205a9fec7e912e0cf4f08a061c4cbee108e870a29c8118f7c0dfa06a4b3bd73e38d5df04916bb246d49ba04daaba2171ed534fadd75d0a29dd6798a0228c73aa594adbeede620329ee8cf48a37746645a784ed42566f5d0d8b525f3ca04fc19ec51f658891a94397efb32125b96196fd075dfd7c455a09d7dab0bd5bc5a0b5e66510ad58275a346354792c9edf47ec73c27042899905adf6534309335348a00aa9c67929df55ddb8edfc9476f6b3d29cb2e9a8930790b2c62b68f62becc8ffa0dc5c6aca57894e7c5c94142d4e461c9f9cb8fa214453597622689d7382f6f994a09d1a1b48475cf893c14100047779a04f3f4362b2152565f2fcd8c080696f8cb8a0eca6729a44aa835548bcb8412b18ece4a66c4ea6017765a6a4cdd63ab9648da2a07e5ffb40099efbafd3b94a89ac0d89988798c766231bb7b47bdfecf4a011aacf80f906a0f901f6b8f3f8f18080a0be6aba9ac1c6352f17e80656c7f0b3953ec8ce0e1f2cfb05ef769bfc37d1d77580a0b7b49995dce6c474becec567a6c96c93da7e0990598ac4dc1affbcd3ad452453a0694a30d09362cc00878eaeb2db522beb8d7c2e48a7e9732960f96d8778589e4780a09e9e038f1f2f81d0bb0e1f416f50de622e9fcecadb4197c5c2bdce5088c7aa2380a07100485452d5c384307581a6945a3fa16ffd690725485a5f9bc8aac1c7cac9fda0b07d81107063377c1c211957301caf7fa17445dcf151837d49ecc9bc64e7ff5980a0fb21b3c21a8b1068229c1e1380f327c83bffd17a6036c867839c6eb6552248b880808080f8fff87db853f85180808080808080a0170d5e33d3b82bf6d5bf48a7894af46fcb1db73bd4c4a95016f368c5f3a96b93a092b46918d999f4142ff51b7b92831c3792050c9e7ead05742e798f42056730378080808080808080e7e6a4e39f34b3ead87fa915dbd1c2960185919de53b3c7f874e595264e401dc59d23ac08281c8c0f87eb853f851808080a09bd40745e6de289b128aab6916d6798db11585a622ba411eb03d6afc0caa67a8a07f61bf209c7648df9408c0f6190335f2a1c2102a686b9a126396fcb835de66ed808080808080808080808080e8e7a5e49f320061836a0c1f6f27ae5c9288f77435b4d89bccee862ac31eaec28ecc280183820119c0f9011eb8f3f8f1a04d888eb12ee6fa4a8928690fd48f98bb24cac57b77882fa6666a2652ace7dff5a015c7e7cbb19f8ce29bb545f4eeafc8c0fbcc16c2e0c5108956a1eee82e2fd0a6a02556ad5586e51d37213057e5e19c90d3414d03fee1e0a5e326092b7bf800fa4a8080a0703410387d7d9609d1965af52a9f748d2df7a15b42e02b55b94758e5f404a258808080a088e97435bf3e80be1450b52537c6db5b0b75b1659c9899b0b41f39ab8ad7c0f6a06fe3901971c7a92e7b8b2b03cc45c8c7483408af1d382af863d823956fdfe5928080a035cfe78b31be841787e703cc87b9d42289b3dc90b5d64d9b317ea7d84cb31f74808080e8e7a5e4a0200526b929e435e070700929daeee090807e6de2b44a067cc89045f523cbc2078281c9c0f8feb8d3f8d180a0963b6126c285f93e0cd2f2feaddac85ee0f8622f2fa2e2e20cf898cd31baa704a01e53e38a9e833581e9dbc4ceba86b77a2509c75030a455684fd2f10cf407c92080a0c29f8c0b42918a8867c13526e8312a2842decb664215d6440d9ff831ea9223e180808080a0fdadcd6251898910b7f8018339f276ce0c62e4f558e3c32a95766cd0876267bda0bad7dc5d75a413e990d7154a5900b7e38a1e76b2aa148d34bfefa4de6e94eccb808080a04e887e5213dfe6d15136bafa77ee8391a7e595f7ef2a8a0ba14b83964659fef28080e8e7a5e4a02002a30e1a9bc437753c64596a2c84be2ceda3def4f945451b62d578011404188281fac0f90161b90134f90131a013bc0867645dbade1b6c73585279211a390a469f9d59573987017fc418d4f096808080a01c6df5e2ac66d99c9d0a2960a0e5ca7cad16ab67cb1da13e07815036f0bc5489a01b0644cbac7785e571f1d6aba44add80421a5995abcb4bedac420fe956b6fd4fa0ca98e4ba4889ea75d03471fa4956ecdb3429fdd741bf4e1f6326d9f3aa19ff828080a04ae18edee506648e4dae52121e7164849fd7242a1eaebb9b84de40dda6c283cea0a3b72c9dabded44eaede04d0a7a76a6b8495953e67d2715b917533304bf5a8f5a011b19623c4c0eb9b8e83a6147529607daf9e95166aa1a96fd522fd38ed1eb68ca0312e841ae67024977e5eb6a7849c40f400923c058ec5f6d0db317a365ce80ec3a0f921a4bc3a81cbffcba66d69ded462f79ecb30feb398e0eea86fc6309b0e8a11808080e9e8a6e5a020b5f6dcccfe4e6ea318646d7821988175e031b3132abb938f3a4fb0b69f17e68382010ec0f9011fb8f3f8f1a01bf6a449a8a374334aabda159fde725a44f7ac969dc92bd2fa42f55de10fe9d9808080a0660f11a869ec3ca45d6699e754b82136beb5058cbb3a3f93115186b7abc4fd5780a0de20d0c3d26b3563d2387122ee5b416f5686ff85f6d4ee5bccc225ae16eb7cb1808080a0098fdc5d082a642164a1b4bc02bc8bb8cd2c95a5771aa045d78f77548b4c91cca03b1dfdba332e77db09c8ef53345ff4ab16ff807abd4a81960dba499cfb1e28aea02bd55d8a8e5d439f5a114f0b581db0d8ca8eb3cbaa5b273438a8959c1b3713e1a0b809d83d55371ab7517bd4c14b37a37ea7d0735d8f33e237ffd1a89b53b799ea808080e9e8a6e5a020712647d34749fbfb3ffa3e7445dc86659747cb70f62498532dd329ea00bb5a83820141c0";
        assertTrue(oracle.verifyMultiproof(account, multiproof, accounts));
    }
}
