// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

import {Upgrades} from "openzeppelin-foundry-upgrades/Upgrades.sol";

import {Test} from "forge-std/Test.sol";
import {EthClient} from "../src/tara/EthClient.sol";
import {BeaconLightClient} from "beacon-light-client/src/BeaconLightClient.sol";
import {BeaconClientMock} from "./utils/LightClientMocks.sol";

contract EthClientTest is Test {
    EthClient client;
    BeaconClientMock lightClient = new BeaconClientMock();
    bytes[] accountProof;
    bytes[] storageProof1;
    bytes[] storageProof2;
    bytes[] storageProof3;

    function setUp() public {
        address ethBridgeAddress = 0x1D5Cc941e743fe21cF8F83602799854c7d4816bE;
        address ethClientProxy = Upgrades.deployUUPSProxy(
            "EthClient.sol",
            abi.encodeCall(EthClient.initialize, (BeaconLightClient(address(lightClient)), ethBridgeAddress))
        );
        client = EthClient(ethClientProxy);

        bytes32 stateRoot = 0x8d755994a0804a7928ff1345878bfe105f0b71ea399aa044f0b23e7e4ab16efc;
        lightClient.set_merkle_root(stateRoot);

        // curl https://ethereum-holesky-rpc.publicnode.com -X POST -H "Content-Type: application/json" --data '{"method":"eth_getProof","params":["0x1D5Cc941e743fe21cF8F83602799854c7d4816bE", ["0xe90b7bceb6e7df5418fb78d8ee546e97c83a08bbccc01a0644d599ccd2a7c2e0", "0x679795a0195a1b76cdebb7c51d74e058aee92919b8c3389af86ef24535e8a28c", "0x88601476d11616a71c5be67555bd1dff4b1cbf21533d2669b768b61518cfe1c3"], "0x1b6fc8"],"id":1,"jsonrpc":"2.0"}' | jq
        accountProof = new bytes[](8);
        accountProof[0] =
            hex"f90211a07f703b1c008e93788d4d163c997cbcd835609dacd0fb5ec59718f82d96c780d6a03a6a6dc51b31efffdee3912635e678adb8e3e675d58fa2be08784e63f9ae2929a04b395d590e79fb3332ddff12e0b87ced77e74d0de3e9dea23b337cde7ff76bcba0d530c00c862837419e0234b28163d3347f30579819618d959b837b001a5defd1a035902d7429f33e2a2e5b23f523f69741e42267df28858713f05460800168105da0d86b200f83995d451be77e958cc2b4f6b9f1ced908cd75f8973fb09c77565edaa03d9d063a2535ee86515cfdd3a9fc85a1b797074131ba0e2140c2d1e551b6f062a0167cff4eb4aefc3f06f828a754de496029e8ab4674e45ea7dfe4ca74e646cc2ea0f2dcc228e9caf4e20df3661e7d31c319de914fdc14c0f6480645dd41cd6b014da0effcc8cd261da30be70db29e9faba4de4177ea90cfea0be47b550ff708a8eecda0a546544eaf39f9f535c2eb6502ab781f4ee80bf27a9dc548d48e91d686f8d1faa0bacefebed6cabb37bc8ea1ef085cd35574c7df3ae4ad86c1f7976f17c31abf11a0a4b53c3f3c15765a5360bde121fb2824d174db77ff18f23336b28a00272abd37a0cbf336c9f899b7600dd7132de73e5c12cd82d296785a7198d5ae72624c7f4e51a0e55aefbb621f3b44c30ba7519badeed0b69b29c7ece5f50038bdf2d6c84c4667a08e3e4cdba72abce2532c8b733ac691b628700fad84c9b8adaf5bcdab3d14a8a080";
        accountProof[1] =
            hex"f90211a060b72a0bff2cf9cd55d29eb51805f49c3aac3168da535f15f616aa8f7376ca44a0c473bbfad3958e61b665a2deeb3739964faec21dc9c93a205cac242d0600f716a02cae8ae4f1044e219cf37acb55854344c55ace6c287dc21686328169acbdb128a07c6e2cf51a63e6adfb0fb96aa2ff8fc82fe9b0bcf6e7febd97c5aaef37f19fcda0cb6c581d3ababcb2e7a2c310920f3232347e37f367d85d59638a0185420e7fada029a6bf9c09f70cdd7a5c99af3feeb591add43e1422ae482b78d61823c39c55a4a03738e009846b238b4eb4c682190932a9b70670a0a3431a46a3a4f45f19a53dfca09b6c59b8ab5827f3e938d24a70b3692889859bf184979d0750ac30c35c96bdfea0d630e6b7dec624f9c06668a13ed7b01c8c5108b5175f4d590b2e1c07c2482018a01260a9575d8c0d5348a4cb32fb8a1ccbf7eb4de8dc5cdb5c7f4201e2cb1fa0f0a0a05169d956f167c122f1758ee2955862ba538c6083b2db8bd1a6a58a95543863a05d5b2880162f68892d16d9a626adec7f07aa257af5d399544eacb2532a69816da0ec163d1fdac9673a2755e23df096dcfe433335002d6d2940705c884bbb93cc2ba092280cf89d4853974a6ee1407acc9a79df56e3f694870000504fd2a8206cf1f9a0cf462e50ff6d0f5fbb72038cfde34fa660fba38e8be7dd7c17e9455535623a4ca055253c240182ece6d456a693906c7bfca6f4581e787ab7a336547633ea82d0ed80";
        accountProof[2] =
            hex"f90211a0ffcf9ddcf3b38166141f318c285a494dbdb57512a071a66e2dfd6a83ee8119caa06ac0d4714ffc96549bce0ba8e55a1fcd39861ebb6c3ce466c0346504cd22df42a07dd5fcb3efb75bd48106294e43e6826f1ffe8cb51c035eb5f5ae0a726d2ed4d5a00302ea54f165642b14796e4f1d73a065e68e30ddf59858553e82820ca6c63c3ca081b79685a34d04c8de025a4570d7e3edcc8dd0dfe72a5c5d6f285ee68731498ca001dcb0a9a597dba232df3255217a6df119fbf273b938656794f47adebefc8dc7a0dc23cb38fe4f9f02c7e6d49d0816158e73f2fd1fa7779f0a2b7a3a6b993aea6ea06817a20bbb6ae21452957310e7418b03021b16056d1135bbaa441dbd53cc8ce7a0a7082a4bc35e1fe9325f2d3bbc7ff994447a8b8f7cbd5e1a1595bb98e35a782ea06e65006326c9929e08f80bc371538d297b46dcab646ff44807b264d018cc5bb3a056a76a1beb1c72aed81a0bd1868625423bf830f32fef837ca8f1b359c2c4ce43a06a6cef8ff65a65b2ec2912d1527b66acde3b57a60c1ce1f6ad78cf29251ba98aa0a238a0f9d0af356ce9f413a9c6f265467e4927e9b72bdc7028b4ab9ffe7704c3a03263f34ad8105d51526737d691ff89b91546c892864059a399e6b86e6da907e6a0ce782f8adbf64f048a17b7429fdb1dd0df3e34dbb6153c32ba50f883d42351eda0213acfedf145236a2d0e1e1619deb9df6f7315b83432b99026096afe2755b3a180";
        accountProof[3] =
            hex"f90211a06c59a1b76a76ad5e64abc72f4db79d26f91734af94b8a48d529035dc500f0beda0deef83e814187c0275f0ce20b6e7143c3f33ea83fef333f3e3b1b739a405b2d5a028b6e166a431c1db2e6a0c4beab2fb3300f72f79c6607e2c348326d8d206ed50a09ac7e95dc8cf33f268712816238f43f30675e30069c42cfa74dfd40d0193d051a002a15a3f63e04ca3935d94d2df96316c0ce6f47cd95a2651dc8e00a686777362a0522b6ea37d56165b9a73e1973722956f6044ab7c7beffb2df6370e7da850f87ba043ae8ef937d172acfbdc3430894cf1c7d2edd21f746f5d5b9f1c08bb12a831bda01e8022dd01590fe8c886576df41133d330b4545dd48db87d5b541f66a3dfe211a0db6fbb65e17b6f5b91b01430b34cef369aa548219602b61e3276769c260526c3a07d3ac79834af43422e3e924b1f3ab76bb759e9dfe3c8d1fab97533741df31f9ca0ecd72cddc81acf36a30ce6cfe8a4174c26fe1038d943796d38865beed02a2c77a03bd8169dad48f0e529ba828f47ca4590db1e434b15fb5c8e2e1733ff0ae4d277a03d04b0c05f4549209899fb4577c6cd7123698a94412f3226280dc6e992f5881aa05679a3b1fc490a0b425035403eef9b45bb3a48ce0696f7425219f4948817f54ba05a6d3d3d81830678d098f488beb2c3bc7a741f78157c5bd9fb0ac451f3e907c5a0ae2856d52c17319c55e3287c4fa0e3cd5dbf20e017b40b3b574380b9babbb6f380";
        accountProof[4] =
            hex"f90211a0627634fb254c8b9990a3d91378032d6f8e5856d223d558b0081ba580c78b3588a09ea1210bf86eeab847f64669edd23dd7f2ad712c6e01bb8c061cfc08cdb1bb80a0f49ca372aea287a981d59921ce40ed703efeb48cb407f1188058dc1a701bb318a078e8116fe2d8de56d5e73447d0ba8ab63a0125447b4ee58486c0bb1208e2b4fca05d6e6c63baeae030597aceb62064a20aeb3b85eee32265daf02070328d235710a0afa42f1be8f090e09fbb71146d4795cfbdb5dfd51d6e2442492620ae22184d69a055326dc15cd4e39062f6da92e29ff0c4cffa23a730b97e245cc08f815aa852dfa0af9e7d01340898c2ff4f4f797f7d06eb8e471ff797f00604690724c4e39262f7a05951c386846638c0e1a3a585ef8fd4a9fe23137119f375a86940ad026271cfb6a041eb8f0fc4d771172265bcfd2a6c6ee608bebcb7ac1e59926acc979fbc020abca00b09ba854c1cd1fc5f2706182c8c6b60857fe59332c28b2b16b142f8b96a5d5ba0f1561c02d0ecbe7cef57f1ff3f39ff959fc86242700d870e4d45bfbf764af5dda05916f45d466a1fedbc22df094c4f33b21cc29af5af0dccb79c3da8b518deb03ba09a69e0a6308002ab40c081f4d1cfa9ed0a1e2e2eca014cb9a19d1a198a76d95da0f0704c695f488de1cf3c6e2970fdf707efb1c2037bf3dd8994c38db25e83d094a01a6c696711c4a81aff5c5d70ef3b95931a22eeda00a6fb7c750ea1d74b6c351e80";
        accountProof[5] =
            hex"f901f1a0dea6798885aaea1b489d2379af12a8b83af845488b8a2b138f853f922270983f80a07b1cd1a3250dd73032a00a60ac0ec324469f1bc4a48ff7cc8b7e8fc9fe8068d0a0ca81d2227cc598af4bb0735580842a2ad4ccfc88baf3ca01494e2f447f279054a0dcd2236baed36e9a79158d8dde0e33c105460daa0db411d789c667675130e022a05451037034bc497678392f6f301f4c61fdc96a5ca67d37af3b7033d2e6fcc9f4a0da4ec7b43debc1d67fbd148bd7a802c3fba4e406058c7d7778abbd08f393c244a0dfa13abb74fd3228ce6fdd088df814392a5b35f6ea51c876210c79a7136664f6a0bdef8f62c5519e3b1c7ac2307925f5c7f1c0049fcb968681d133cee995d4b6c9a03ee965e541d3cca966e0a762fcb5f29d42e618e0e01cb343b27b29c07f17806ca0416f6ddbf7f55ee342917f498a6b582d35ccfb49f32c46f9c4652485c5091826a063f5b9f6c21c0c37a0761e26719cb3d5858c70910ffafec74e3287e868a51c85a0b6ed2003191371bdff86d137a70e44639c3727ba0072d05a659367e43c623850a0628c45709e035a5315f719f5c947f010509f3ad402437439244586f2454c10cda054517623c0ad80acddfa0c9245d773ccba32e397b90482ac50a87b084a5d6a23a0e0a9665264903d4cca932e411f01ad793a6d3aee878ad2bf8f9cfc26c5f2e4bf80";
        accountProof[6] =
            hex"f8d1a07dcb67e5120d2882d5553a9da934fdce05855ede52554fa95dd26321668b58a0a06d85662de6f3971bb24d3ea2ed454cd8272093a682a4fe6f1842c5c7cfda6c95a07e818d4628f6532f138aa9c0bda799e219e9507cb46a4f038995c5006f1f9513a02ffa262eca20cda078d803635befe466c58b9d7a5ce6e648a09c3314acb725518080808080a0c4c7fcc17b055380bbd5903b2260de6997b659a9f00a0dd7948d141d38e9218f80a03eefa0c59fe37f7355f08c4f3131b872410fe3f216f31124da693067a4e02ac58080808080";
        accountProof[7] =
            hex"f8669d33b31c71e970717d085a00c7d49c80eb24087608d0d93bd471fd7503afb846f8440180a02d78e9fe8d90b9d3f98d09ebb78265f13ba22dd104ca5b9e72efe9907d71cff2a0c08bc27df457d1f00bbe74a7d4ced8568340d74b5043063aaa67d5fcba760a80";

        storageProof1 = new bytes[](2);
        storageProof1[0] =
            hex"f8718080a0b2c3296ebc3e2a741a45512b69a50b4ab91aec736f4db4308843a37ce33559ab80808080a051d4efa23812550f03e61787d034e40a4fcaf29a55d871d5306ec8626bd2d0358080808080a0b7370fdb590ff64558794a5a1d34fea2fe717689de8095e2be48c2a489c8bbcd808080";
        storageProof1[1] =
            hex"f843a03fef4bf8f63cf9dd467136c679c02b5c17fcf6322d9562512bf5eb952cf7cc53a1a0b10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6";
        storageProof2 = new bytes[](2);
        storageProof2[0] =
            hex"f8718080a0b2c3296ebc3e2a741a45512b69a50b4ab91aec736f4db4308843a37ce33559ab80808080a051d4efa23812550f03e61787d034e40a4fcaf29a55d871d5306ec8626bd2d0358080808080a0b7370fdb590ff64558794a5a1d34fea2fe717689de8095e2be48c2a489c8bbcd808080";
        storageProof2[1] =
            hex"f843a0370731c4fc4bf9cd8fc2be4d898bd67fd357eb0135035bf4500364b4c42c4fa5a1a0405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace";
        storageProof3 = new bytes[](2);
        storageProof3[0] =
            hex"f8718080a0b2c3296ebc3e2a741a45512b69a50b4ab91aec736f4db4308843a37ce33559ab80808080a051d4efa23812550f03e61787d034e40a4fcaf29a55d871d5306ec8626bd2d0358080808080a0b7370fdb590ff64558794a5a1d34fea2fe717689de8095e2be48c2a489c8bbcd808080";
        storageProof3[1] =
            hex"f843a03fc7941cecc943bf2000c5d7068f2b8c8e9a29be62acd583fe9e6e90489a8c82a1a0c2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b";
    }

    function test_merkleRoot() public {
        bytes32 root = 0x0000000000000000000000000000000000000000000000000000000000111111;
        lightClient.set_merkle_root(root);
        assertEq(client.getMerkleRoot(), root);
    }

    function test_bridgeRootProof() public {
        client.processBridgeRoot(accountProof, storageProof1);

        assertEq(client.getFinalizedBridgeRoot(1), keccak256(abi.encodePacked(bytes32(uint256(1)))));
    }

    function test_multipleProofs() public {
        client.processBridgeRoot(accountProof, storageProof1);
        client.processBridgeRoot(accountProof, storageProof2);
        client.processBridgeRoot(accountProof, storageProof3);

        assertEq(client.getFinalizedBridgeRoot(1), keccak256(abi.encodePacked(bytes32(uint256(1)))));
        assertEq(client.getFinalizedBridgeRoot(2), keccak256(abi.encodePacked(bytes32(uint256(2)))));
        assertEq(client.getFinalizedBridgeRoot(3), keccak256(abi.encodePacked(bytes32(uint256(3)))));
    }

    function test_failOnIncorrectEpoch() public {
        vm.expectRevert();
        client.processBridgeRoot(accountProof, storageProof2);

        client.processBridgeRoot(accountProof, storageProof1);
        vm.expectRevert();
        client.processBridgeRoot(accountProof, storageProof3);
    }

    function test_bridgeRootProofFail() public {
        bytes32 stateRoot = 0x0fd6262cbcd27159356419dca723374bb7073bd7402b35f7461704e077a02b48;
        lightClient.set_merkle_root(stateRoot);

        bytes[] memory accountProof1 = new bytes[](1);
        accountProof1[0] =
            hex"f8669d3b673e571fbd6665e87cf8fcba9fb5ed2dcaba58ab6ccf9542818163bbb846f8440180a08aa1155cba880c632d39005ac99902ef3c058f1f78e211654f597e8f5082583ea0f96223f375264fd32d76bb95755f6bd4ee7efe35fbf2daeaa2b76c3421df08ee";

        bytes[] memory storageProof = new bytes[](1);
        storageProof[0] =
            hex"f844a120290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563a1a02a6bdefe81a8e9d36fb1a8f8fb0b3e6e5fb45aa05b8542441a4c552b51e13fa7";

        vm.expectRevert("MerkleTrie: invalid root hash");
        client.processBridgeRoot(accountProof1, storageProof);
    }
}
