// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

import {Upgrades} from "openzeppelin-foundry-upgrades/Upgrades.sol";

import {Test, console} from "forge-std/Test.sol";
import {EthClient} from "../src/tara/EthClient.sol";
import {BeaconLightClient} from "beacon-light-client/src/BeaconLightClient.sol";
import {BeaconClientMock} from "./utils/LightClientMocks.sol";

contract EthClientTest is Test {
    EthClient client;
    BeaconClientMock lightClient = new BeaconClientMock();
    bytes[] accountProof;
    bytes[] storageProof1;
    bytes[] storageProof2;
    bytes[] storageProof3;

    function setUp() public {
        address ethBridgeAddress = 0x767D8155279C0655a3c7206Ab4B30F68063c335e;
        address ethClientProxy = Upgrades.deployUUPSProxy(
            "EthClient.sol",
            abi.encodeCall(EthClient.initialize, (BeaconLightClient(address(lightClient)), ethBridgeAddress))
        );
        client = EthClient(ethClientProxy);

        // curl https://ethereum-holesky-rpc.publicnode.com -X POST -H "Content-Type: application/json" --data '{"method":"eth_getProof","params":["0x767D8155279C0655a3c7206Ab4B30F68063c335e", ["0xad67d757c34507f157cacfa2e3153e9f260a2244f30428821be7be64587ac55f", "0x6add646517a5b0f6793cd5891b7937d28a5b2981a5d88ebc7cd776088fea9041","0x625b35f5e76f098dd7c3a05b10e2e5e78a4a01228d60c3b143426cdf36d26455"], "0x1b6fc8"],"id":1,"jsonrpc":"2.0"}' | jq
        bytes32 stateRoot = 0x3502d94fb6df670509dc7a69d0f3de33883a83ddacc28f5811753dba0f8bd84e;
        lightClient.set_merkle_root(stateRoot);

        accountProof = new bytes[](8);
        accountProof[0] =
            hex"f90211a04907dfad7992c688626f2de1a6b63081516bc3fccfa22f430f7d7a70a87065eca057cbfcf4a70c47eb46db011b2a9cc3ba47f6bcaface2173fe47f98d41e6bb7bfa0a33f83b9722faf2f150d2b32279975215eb060c65b7d1858d5cf6a92a064727ea0374352de2f60f95bdfb3e7114543066794ab081f2ab8883769c415d456173137a001987ac1f63ea87382960db214558f7e345e4f82988424112cba241d7973a893a0a983f876bc9be44a59e5751fdf6ae0b147fc147d5a95706f8ff881d4d2e54108a0678e39f3b4060238da81b71016d7bf022614db48927e7e12223590308c457ee6a006416a4b2240d78ac621079a7059e3dac329b4abf9a12f9602baf1885106185ca0a50038c3aa50a0410f5c72a94ebc5d4f467e07cbb4102661f46ea5e34efcff4ea092b37e2180387af36a8be74e07d20fc6543e35c71605a64271694943c6843ca5a07fcf87427d57b331ef6d918ffe2cec8bb1961af76892f975c74985643c015d5aa07335c75b69ea808be076970652e4944f1dbcc3358f7eba0f9a934e178fbb76e1a04e67ce348b02e37beeeef406ce93ea06072e32aff25c04adf2e38b031ec98398a04a06e84c1c8e1a046daa6debd57ce2cee56064c0115a47de95c90a300469d731a0d5c0b209890a5905fd25f174edc098a5474898537334e3382c2a34a0a3d7430ba04548da8ba7d02ecc26c464a6455614cab4247917c69c1b5070c697e1ba09a62480";
        accountProof[1] =
            hex"f90211a0a3b2307bb7f6b7b3f8b4f8f8df5fb515660f62766ba57ebbd83f51dec58dae24a02289425110ea5c6331b3075aceecc957144aa13cff338a4793189ee544f233b0a0c26c99554ecab9a07a82aaa8f4d725c46a1c5ab3fd85825efdcccb577b159d64a0e49cedb027f3950992d97441c75c261c554012da13d7df27d5dce06724d3d1a5a04e78864add048159d5253b5878da11ad3ebc450e59f33415e8656c7e37c7d95ea0165b855a67bc095e31c679bb87caed3a3e20c575cf5a826561abeefdbf9d7506a024fb6f32af5423fd894dbe86a6184a94d32d11388b2761a14fe44f71a1775c0ea0c69b6e7b6d5891d06069ba3ed7c305d0f1203ef8d9e521d375a9791833e916e0a05e8d0cc0c7576415dedc8b00a58db87d206926d64463ba99fad316ab3479a4f9a0239ff66175bfdf97154e8ee413c2b15eca6482938465fabf674d3759f9bfc7dca064ea469f280d21e154f4adf1e8fc91d12a9039f6fa3bce5418783439c15818e4a0c9a5b62fb5ccf09110a9bc19eaccbb0fd5e1adb40a31acfeed9bdbec7c4aa2b3a007c065faa90403a9f5a61bcb3828c673776b3554f71265ce2b5bf07d4af16e76a00e680643156b4e9895adc8cc3478c179589ebed6bdd9a7a03c46885b65e6be5ea03f695520447b36fc3871185f920d2bbf16acae41990df886a64f140e3ec051cca05c5243ee53295cec3aca0ea8d5fffc2d6cd9904e03e07da8388fb050d49a087380";
        accountProof[2] =
            hex"f90211a0adb2c1d33fac05e453e5c24afe901a06965cd6581377e6b4566ed87c073eab6ca0c60ce27292e2c5a7e9f4661a47fe64a65c8cb4a50ade1c49bec4c62d83027712a0963b18ca873e93d3e4f906f9a8a3ba4bd8abea0655d120b1854d16a97848121ba06281776168bded3b42e6523d600e73ddc3894ca7b1eaf876f4947fc65eb7d96ba0c04883afdfafe2b3dac4dcb8e267424ed4627fca76937e0fea924df0f8bfc845a08258b3c1cb95af2f8a88a1c0d375d237d51dddc973b5352597ef848f40a1f567a0e51ea9fdc1a66208aa987e70b832405aaa23e30b6da44ae2e2c9cf7fdd416283a036ab072a98aec06868744ed488a8457a5daefa5c40a959bcbc49a277c6d88893a0245739ec07ce60b85d09df3e1005ad09747968673d14e8ef50d961f8cbd8cd4da019e03a3230f83610d6c55cfe9f21d0a6b10902d390de61e171ab0614f7338c1aa0887599d8d6bdf617704bc3be1db21d3cb4303f747d8fd6e53f4435d11bb46cb7a0799dee04967d0064e24ac552b4ffc55137830705487ea043558e7d07b5bd9fb8a078acc2112603042530f8e3cecc2b21228f8ea2660a05e23c8c0f7af2260d25a7a0bba9cf4efd67cd7b635d507a13cf807bc6288ef8ac369a7556b84b2026c5aeb8a096358f88520b1729b4c3f7c5c234d36ec92bc95aba7eaedcddb26c072c87c455a0f7de287361cb537fa4c01cf12775fc79f7566293a9416c33396907074350b63180";
        accountProof[3] =
            hex"f90211a0dd156e0d450c700bae7c5bee398c39c5b2bc8a7de7d54a6fbebc0bcb251813e6a05b2bc6c9c609832e209bef3a9581efce40af9c8a6e85e0a57bcfab3297231cfca0bf323d2d3418e6c5cd8cdf0286147f106ceb162c23f8468ee3ac6e8acb4f6383a079d02fde492af96309bccce8447c2f2d830a8cf21f4da9152572939d972ceb79a0f14b25b062f5066e85d75ce625eefe1ebda9c50ade8bcee17d58ba948d313ab8a0bd8ab64c690bfd5f48b1b2cbb47bb94a20e9de30291c9056807cb9fc4f586f64a0ee8531d36c33c537a30b9b39f860e78d1cd5078970dbbbb3d72062998f4c383ba0ab5ef96d88e45d1e75538ba941a2d144025c1dc2db153e0d8081873a652f4915a01903e7fc8e88eff0856f4da0f2856d19cc386fd5f0e5e5265ed209786546d9d9a0c0320e0a168848f9aadb786efedcda64603639558b70391933e40c950de2119ba0233937bbdd1557108c18c26b7fa3aacae7fd06f43d6b467f155ec80f33a02d1ba0640ba2c15ddea9a5b0a107f16ab5a71bafe49ebb6705366cdd9c56cffdd7f913a0038125dab888f7a24a60d9827a1304c5cfd47a4ed9112029252ea98b3f9c3eafa0da156ab3f69410a6691244784d0348648501aed0af87f5701a7b9b9bd24982aca02253e72bea6a5017a89d23ae0160345d27d028ce39519b7c98b5abb82303fe94a04bbe7027a11bb2049fddaa7b63459b13155a2e40074de8cc59e5a7eb0262d94380";
        accountProof[4] =
            hex"f90211a0e0cd0bd456a59fd3656bafcbe6e4b90a52a9c3a196eb5b5031f3c6def22cd84da018dfbb929c391ccd1c87ca16b573aa4c17d10453c4f5eb22f78814083fc6d1b0a0bcee2569073365fe01039102794525b8a6a57d656d9450d72d014d031dc2edada0873b4d6eea74d85ac9e966185bc6e8aff433c6be2235dafc848fd291b67c7de0a07f09007fe49c6c0f0525eeb8e1b91f937d13d1fd3ed2badaa0c6b5742fa7fc9fa053febe7d8e12e958f3c2ced8270342b13a6f48fec5f4f83ed01af0cff568d647a0d5b75971b23b89afd0a0d9561313a89450f37e182258e151fc41273ced0e001aa07557e51a93d96bbe0728acd1d74491f378ecf51a5e995cc8bbcf82afab58dba4a0933dd249a5faf831ce28ffe4ed786b1fe69a93371b11790fcdfe6e1f570fdc2ea06ff4460cb555fa9c421701bbcf269927a53a74a1356a583a1fe54e599bf36673a0569f93139029529d87ae0151b6a84777876f9d35d543109055ed5dd835e637e8a07ccd2ab50868b5499f8539677cd802e66ead9f0d870d7021187da0feb5b10347a073a0f8772b2d1a8cf1b0d71caf25184881203ac75aead147e1d18ceac08b3d32a010803000694ae1a40fb2929b326090a2886ce9a2ab8e48fcdce2fd27cd077236a05fa254140449a8f0d037c5947a7581c6b1eb991fe80caefe6d3a740568eff54ca093a799f48076bcc05d891475592a6c57e283b5dd03d768c66644845ead14800580";
        accountProof[5] =
            hex"f90211a0fb9c54c9532d2604727d48f11942d6eeeae17e132532967642050788c5931cd2a03c0e82389b42df025d1c891b0ae89307af4d3cc824288dd7bf69f6b324be9c35a0da6f0a08f37c6e7e96a08c00f346b830c5cd8fa9390434ed925a0bcc10b5eff2a07a8d9ea49b6247808e92a629ac509a901d6690b58e3a70cae301ebff1f84a8eba0ebf6675eb4c385ec9ab0100178486378676ddfbf6bfcb706f891b1cae2542cbea0f0655dee4b148fbd323a96dfee41dc0277d9b3cc71834b3c7bc50ffb1be29a34a0f3f6b867473fa72e189d921d823b7ec9c727e7f462a516596bd5b88ff39fd7f3a09cd57e9c5ef3f09a600a0dfd0a02a34f231b60370cc0da65abeb0f6b654972dea02d3375d14bb5af9d1e231e480a930c2cb1f58ee6c230e8445fcbc683e469ad78a007b0b51b943fbe5cb5ad5e9c7947aa04833c4e9e66b560d49384efcbdc673071a03329c5a652ad19456fb80918bfdb6a6be6afac504f0212b645b727aaff4d5734a03581c0946fac1f650b6a995fc4f83fecd8066e610a4e44c8f88f89957a2a31dba050dcb679f2bdb838924c093246c9736e0072716f7971f30f696f1dadac7a98ada03b48146f9851db895b54aca5569891d4e7d9b0303572eb83f7ab18bc9dcc2c4aa006bd54231a81e402d57e32e2b7c15f87b1cdd8e791fb5fa975c76ad56d1f8ddea06727397cca8d00c6dfb7218574583f210132dd19cd58a2fa8674b15888307ad980";
        accountProof[6] =
            hex"f87180a0eb4ef6e162638ccca1808b48f762cdfab683f6e60586063cd97fea1cb99bc9468080a0d89d4967ab5fe698bc1083c50faf68d3bec87c89bb3b2bc964c43844f4a05cbb8080808080a016b493ab6b394efa19cdeb96c0022f348ef6f437945ddb2a145c6fb37c2efee8808080808080";
        accountProof[7] =
            hex"f8669d32ffadce7e7a578ed5e8959bc0c8ae7b294067f184dcc6d8415442d863b846f8440180a0a553deba895b10bfd6663147aa470dcbf6de59e303489d359feee2b2a181b57aa0d2a8a983bbe698afe34b467000cbd8a44184bc476ce44444e608206f513fb432";

        storageProof1 = new bytes[](2);
        storageProof1[0] =
            hex"f85180808080808080a0cdaa14a41309204d3c222364b005036da004d1741b1dfe94497950442c6b14f8a0e121a6b9fd2a2b5b241c75d4cba4227741615ec6ada82a40048ed44df85f4e308080808080808080";
        storageProof1[1] =
            hex"f843a03048725117155ad5ef9cb75f77fbe235a4558a61159f5364c90d55c3a0d15b7aa1a0b10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6";
        storageProof2 = new bytes[](3);
        storageProof2[0] =
            hex"f85180808080808080a0cdaa14a41309204d3c222364b005036da004d1741b1dfe94497950442c6b14f8a0e121a6b9fd2a2b5b241c75d4cba4227741615ec6ada82a40048ed44df85f4e308080808080808080";
        storageProof2[1] =
            hex"f851808080808080a0848df93b74635eb0b45e415e493c3962b5c965bace0680c16a9a8c67d610d6f180808080a0de47468effcc4b55aed74982ca0f09396558d8ae056cf1218893b15633ec83f68080808080";
        storageProof2[2] =
            hex"f843a020f249938c4feef66b9076a9dee14bad2f4e6b5ee27a7222e6020ba7aeaaace4a1a0405787fa12a823e0f2b7631cc41b3ba8828b3321ca811111fa75cd3aa3bb5ace";
        storageProof3 = new bytes[](3);
        storageProof3[0] =
            hex"f85180808080808080a0cdaa14a41309204d3c222364b005036da004d1741b1dfe94497950442c6b14f8a0e121a6b9fd2a2b5b241c75d4cba4227741615ec6ada82a40048ed44df85f4e308080808080808080";
        storageProof3[1] =
            hex"f851808080808080a0848df93b74635eb0b45e415e493c3962b5c965bace0680c16a9a8c67d610d6f180808080a0de47468effcc4b55aed74982ca0f09396558d8ae056cf1218893b15633ec83f68080808080";
        storageProof3[2] =
            hex"f843a0207cfb79f51a1ef9d29eaf1fc4b2184dafcd0392ad973adb4a62256baad1682fa1a0c2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b";
    }

    function test_merkleRoot() public {
        bytes32 root = 0x0000000000000000000000000000000000000000000000000000000000111111;
        lightClient.set_merkle_root(root);
        assertEq(client.getMerkleRoot(), root);
    }

    function test_bridgeRootProof() public {
        client.processBridgeRoot(accountProof, storageProof1);

        assertEq(client.getFinalizedBridgeRoot(1), keccak256(abi.encodePacked(bytes32(uint256(1)))));
    }

    function test_multipleProofs() public {
        client.processBridgeRoot(accountProof, storageProof1);
        client.processBridgeRoot(accountProof, storageProof2);
        client.processBridgeRoot(accountProof, storageProof3);

        assertEq(client.getFinalizedBridgeRoot(1), keccak256(abi.encodePacked(bytes32(uint256(1)))));
        assertEq(client.getFinalizedBridgeRoot(2), keccak256(abi.encodePacked(bytes32(uint256(2)))));
        assertEq(client.getFinalizedBridgeRoot(3), keccak256(abi.encodePacked(bytes32(uint256(3)))));
    }

    function test_failOnIncorrectEpoch() public {
        vm.expectRevert();
        client.processBridgeRoot(accountProof, storageProof2);

        client.processBridgeRoot(accountProof, storageProof1);
        vm.expectRevert();
        client.processBridgeRoot(accountProof, storageProof3);
    }

    function test_bridgeRootProofFail() public {
        bytes32 stateRoot = 0x0fd6262cbcd27159356419dca723374bb7073bd7402b35f7461704e077a02b48;
        lightClient.set_merkle_root(stateRoot);

        bytes[] memory accountProof1 = new bytes[](1);
        accountProof1[0] =
            hex"f8669d3b673e571fbd6665e87cf8fcba9fb5ed2dcaba58ab6ccf9542818163bbb846f8440180a08aa1155cba880c632d39005ac99902ef3c058f1f78e211654f597e8f5082583ea0f96223f375264fd32d76bb95755f6bd4ee7efe35fbf2daeaa2b76c3421df08ee";

        bytes[] memory storageProof = new bytes[](1);
        storageProof[0] =
            hex"f844a120290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563a1a02a6bdefe81a8e9d36fb1a8f8fb0b3e6e5fb45aa05b8542441a4c552b51e13fa7";

        vm.expectRevert("MerkleTrie: invalid root hash");
        client.processBridgeRoot(accountProof1, storageProof);
    }
}
