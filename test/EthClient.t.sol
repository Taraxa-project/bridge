// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.17;

import {Upgrades} from "openzeppelin-foundry-upgrades/Upgrades.sol";

import {Test, console} from "forge-std/Test.sol";
import {EthClientHarness} from "./utils/EthClientHarness.sol";
import {BeaconLightClient} from "beacon-light-client/src/BeaconLightClient.sol";
import {BeaconClientMock} from "./utils/LightClientMocks.sol";

contract EthClientTest is Test {
    EthClientHarness client;
    BeaconClientMock lightClient = new BeaconClientMock();

    function setUp() public {
        address ethBridgeAddress = 0x6C5ACDE68a33b39Ad4717a7a904a9b81CaaE18e3;
        address ethClientProxy = Upgrades.deployUUPSProxy(
            "EthClientHarness.sol",
            abi.encodeCall(EthClientHarness.initializeIt, (BeaconLightClient(address(lightClient)), ethBridgeAddress))
        );
        client = EthClientHarness(ethClientProxy);
    }

    function test_merkleRoot() public {
        bytes32 root = 0x0000000000000000000000000000000000000000000000000000000000111111;
        lightClient.set_merkle_root(root);
        assertEq(client.getMerkleRoot(), root);
    }

    function test_bridgeRootProof() public {
        // curl https://ethereum-holesky-rpc.publicnode.com -X POST -H "Content-Type: application/json" --data '{"method":"eth_getProof","params":["0x6C5ACDE68a33b39Ad4717a7a904a9b81CaaE18e3", ["0x0000000000000000000000000000000000000000000000000000000000000004", "0x0000000000000000000000000000000000000000000000000000000000000008"], "0x1a5e11"],"id":1,"jsonrpc":"2.0"}'
        bytes32 stateRoot = 0x6cad1267b11a0388647c38a9736b7d582f86d73ec4429a00da41ae2ba26a90f5;
        lightClient.set_merkle_root(stateRoot);
        bytes[] memory accountProof = new bytes[](8);
        accountProof[0] =
            hex"f90211a0b6c25cd2d36dd7f09056d2443175de2ae5e5778a583e33fd11ca344c4b23d337a0eecdfd4c367c391e9528c086e5575d6ebc9cca19964b86c2da203d800383771ba0ccf6bad8f8b6dda6b35875db72311529ff477cd94b5cdc681c5ea0e0805cba77a0d49258e4894bf2937f3f77deaa2814203a07af4bb8fc7c6c16158378ae1cf4dca02d26d7631ac67e28c9c158c996a604cb9db0aa2754cff5569174f243cf92d298a0278f548601916bb1da61417cb623c8157ab08b527d0c5ae19792f2d28d213153a0c81b82fd96c51940e259f41d3b85eaceba64472c0f56eab5baf1ede4f1a09a93a04614c2dea98261da26d5d54078ec5d743e94f56e218cfe4444b488a955306540a0efdf3a8669024871c7505a46c8990030248f5f4049309a1e0921fc70b551fd3fa060838cc0e723d9698903567ade633a804dc5ed813eca48b14a6b226ed47f3283a055020a99ecded8af61d12e24281a150db39175d1cd0bea96fca98d926fe3b8dca043e8f5ee7621d8d7b7b0d4a41635c2961b5b20818eec17574030f2397da36853a08fe0a4abc0273a4c935ac544558cf54f653b8c45c7eb0be5c20568e02687ce99a0eae5e1e5194f32076f75d3b1c335631e7538f3effbb26b1054c6f4596e7d4f34a04020230e64b51f257b0fb48ccedaf7b94fbfd508ceafbfd58425c43ee9761411a07764afc3f1c87b710455fdcbcd75d64968bfae46fc680578e85c489cfa8f7b0280";
        accountProof[1] =
            hex"f90211a069af8b81a5f426a320ad4bb6d7148e7cc4747e18ac1ee22d116fb08ead15b076a03168319990a8f3b739e66ead8db7d3654f69e650a48859b1e48ad638c8c60b5ea06b79981c4c2ccaae92448a4ecd557da43743b789e542e71d8b37a44b0b5356d1a077cc62f9bba60f23f40f4fac6e8dbb20225e5bc4ed9318549d79a317813f930ba03c9618e811703b4991627f7f020a387aecf80add0d289bd33ed524cdeaf44bcfa08736e4c1849045024982f1db385dd92ca9d89ad70de0ba8c03b3c272fd1abf59a0d4fc78473d33e8886c7398e17242db6f58798dd9ff4a775c10d7effed866ab0ba0a5437d9d4f0fc51b3addbd1ed4e4b59834247d1288bab7ecfa423396c2727e4ca0f428ff54d2ff361ea4fd7cffefb99461712d895523dffe663e11a0977310fb29a0377b3ae5c0d26f041eba05c21f4e4ae20d99f2c0a38ae78c635e9e04ebacca90a04b18f4b243c4e77e47d5dbb752c5a65701487c0e6eb95cc3fe40e8116545a8d6a074cf37e58326d85f9ebf6225867b8e09def3dbb37b0281c67d70a000e78a69aaa075d12cd5ab02b31ba561395a40e0c643d0cbb8be86a8e3b3b4103cdc897fde29a0a54ae0878ecc1147fc497c9e26f13b5d3f86cd745644a12ddb7abf4aa7db5ea9a050c50a02e5d5396ca7b5762705dd09e847bdf466749d01d330005fe246e91987a0270453568b94167a07a56c76221cfbeb9f7d5b2906167842f16ff7a9659ad93c80";
        accountProof[2] =
            hex"f90211a083f35b01b57fef22292e3d481adb1920d46c588acbda224160ec09726907a532a09396af314fa11754cc932872a017ea587b876b6dfb4944492f92d8ac9d371114a006bf3d8211106d049e4911a35293f5eee74106f90fe787ecbf05098cd4b3b8d7a097cadac48d3d9754f26b1bca98dd81f848919be067d46d5deb32e32f2623e601a0758d035a1d05e960c0e321d21e25c192fb78cdf5299e33b1f5e7fd2b7bf79f10a0eaeb585377c736ae6ef89d40c741ab3872107bc8082c1ac788a63858a91b7c45a0a2f28268d9bd4510b5d7514df9327871ab1860ebce1e4d30617a3590851d85b6a0510f2521be9baca0baf7e143a005789f604288a0966c5baab91fc9b52e54d18aa0731cb1c09bd69fa77901e4c6f4661a8360181773a9047466c88c5f8025bf5421a0ee3b728c94c86d4ab3ccc2990523732f59be83b7b180f07644763552468f3f77a0fd6b8c84190efb01b8a292a5e8a235f8fe8a15d4f755bee38f681396c1dbf745a09fd66036bef21231f4cbc8f8d35360b991338c947435593563df4f39a02a8df1a0311f48e1f475a4cbdc036c3152e5a92a572d7a14e53e600e796b79d099e8e61aa0de8a37437ea5f363d200d8adc1a10769c68728fd47f84b9d1a3514ae26ec1844a07e7ce16eb93d63c42a23595d736189a4275103776d30e376d96cf0b3f0083a5fa0f956a291c7bf2ca4a3604cb5cabace6c00009757e1121731bc1b304db07656a880";
        accountProof[3] =
            hex"f90211a06537c90d5a659bd3fb5d0375eda88206f0499a2b6daeee6732ab70ca7793fef7a067e5dce1dce29681343ce422c98a7957a5253e98bea87882c7e450833acd7f73a0ac22dcafef69d2ca60e10ee65302cbc07233a87b30f9523d8ab0d1cae1a26de4a00b4f03f0f493068d5e2a6ccb6c4902017059c69c785f92e4a348b89b8c3266a4a077d2dd4f33dde249a16b7d81878842bd3202bd032274af81d504a733c518e57aa0eaccbc6ef0c4e34d2a7d9900ea29191d7274516f4406baa61803dd01c2df78f1a0f78521eb6ac1b99e7b5678b3331aaf7ecc83a4ff54897f38d2fa8b16558a29ada0dea0b6656b7b10736cd2df2165e4db4fe90f4f20f65b31126b518da40ea394dda0f719ffd26643fbabec9a5b4d9b746e51e9d992312d59d7cb90691ae4b1fed6a8a0609cb26de0c47241a70e9019c75a29decb3d3ada3944ffa153a99a0f97ccdd02a0df7640b1073b9a61790be8e082a5f22d26c36bfa60e1a50d223c17f8b4ef225da0bbc6c6eb8b96649daeda63a32bd5f6e60310caccb6842b01630b7fe7f765ddf8a0b50dc47fbfc3a1a4d0fe1c6cb8d3645e0a229ae995cb95a9f5b0ca909af7baf9a0c1ddc08a74529742f9fb240de1b2a9cc9eb549258f6c73e2af29e98bedb144a9a03cd54017fde30e4a9368ff8def886ce33fc0ac2319ea0e68f8f73c64114dc8b7a0f045221806109ce6310f7e7b4b35532eb0fbde46c20d9f663c7c6c7702addeab80";
        accountProof[4] =
            hex"f90211a0db137f9173df092a4bc0f27d84966e8fa753c0d1e03b319553e26dbd4c646baba0e3d4a3beee333e045d140fa202e10bc8e4d7a8a56620e79d1534634cd8a9577aa01817255aacf35dc760235cc15c657a3c50b05fb04f46f22a9371445d27453f9ba0537e61d1e304c96d69fde404a3706e2a45944b22148c54efebd00b405e6f4b74a0b1e15dc4154af9a1ff88188b4772fff749260d4c56ec8a02ca9e6fddbf724692a00ab134faf75a1cb4911174f3a02921ce75f57e8099b52b4d34ccef34583852b8a0e55ba2cb8b8c436459d3cfbe1955d111fa791d4361bd7f8189d184b216fa1e94a0f446422dfe87bb4801866e845db27b035aa8eb1b1dbd22a6fb43e045ce84e368a0caaaf79d028b804805d9bf9a580a23e7ed92a956d4806257c35625d5e5fc0b24a040534d574808f062674b739c6f1d8b9a7648330ad2c39146e99767900b39abcba08b04796be4f6f2b7fb0b90efb73be272747702898788cf7a70e0a82ea876c689a02f0499e8af881cd1025583c5734ca06730ca9cf6ccd93a1d391e02a7ab258ed8a0654ce9557870e5d47482c602fc81e452cb4b7803a615423e04101c23b31b034fa0c5a669b35681b1c11df10182ad14c49d6a0f5db05b65c069211e9cf40fcbae48a00843291d40ba87d74dde02f53a9d52ad203769a22bde15d8e664da0e158a9489a04c4004381d8b2c4af10769e1e85029b94dc96cda65b2ec454fd69a7c54c8501980";
        accountProof[5] =
            hex"f901f180a0ccde711542d6fb8befad126d0c46cb4205c2874a828463f4de788a55647e3bfda0adc14a7b04999782aa366f73f958556850564e8914cf0970b05055186d8999b3a0d91a9dcc3d37f52c7c7bf54e77393b1e1e14ff45af2e03f032300a5e5dd9a2b2a013c563dda9eb2f63ca50bdeaf3982d1815ede5c04735d190d849e637d2b48778a09e6931e5ee88518ba09ef0cb30001caff864a3978fb1ca9470c50dd227e3fb32a07fcc38badd9fa27e648d71512a2631b39b2a9d64bc0bf71ea686724a262aadb0a037438acb30a3d106d88f9decb5db42799281087320e09e7ea20707a26c99eae4a0d56354c6ec9fc4648b1b9b52fe45f1555acfdffd80a5d905a97fcb38a4e8a238a0be30aca1acac64e751a709cdaf99a764411ed34fac2313e6106ade7f64c2c44ba0ed00de1d82e0c5e751722b39cf27ebb5c90342a335dae608cb1d04bfc3a840a0a0be5c7ab0ef145349cd971200b3e1a566566ff4566f75e6655d2a42f96fc7444ea0c57cbd9068f68ca6e5758e4057ed4528e6a2f1e57fbf3263284e1db173ac0a5da0d00fba6b5e4e621a9eec2b5eead3ec0b90a11ae633dd8ed92cd09d6e7b700db2a08bd588eb48f7a05499d816a53d48bd8f98760916920f58a26dac2e574f116da0a08332f0c7692be9c509b296fe472a5f027e2361d6bc07e06c75b559795b961b3280";
        accountProof[6] =
            hex"f87180808080a0589588cd37e209ff5c33a45d1d1153b2bc18d752712f473f0e8b3db8bf5f22c78080a0003fa6a72d824036386ab0b00471865aa6f520104cfbfa6b5fff172d1a75f79180808080808080a0624bf308a2581fa57268bff364f2f7d2719f0ab9d4e1098791830132b2538f0380";
        accountProof[7] =
            hex"f8669d3b3a0f2574e9f4611306e07f3110a9ea75f8384df922cd9f958052a584b846f8440180a07be85336b4f179529abd1039d4250e7297469e0ae6ae2ccf3f7e054ce4ca7d55a0bd8d7f19e15ad8a85950a3d87a91e11c3db16171bed9477d6e03629b27105517";
        bytes[] memory epochProof = new bytes[](2);
        epochProof[0] =
            hex"f8518080808080808080a0071b011fdbd4ad7d1e6f9762be4d1a88dffde614a6bd399bf3b5bad8f41249b5808080808080a06804caacbd199650c56afd63e3f3c730c2d3fb43f429819398af8e7d12f66e5980";
        epochProof[1] = hex"e2a03a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b01";

        bytes[] memory bridgeRootProof = new bytes[](2);
        bridgeRootProof[0] =
            hex"f8518080808080808080a0071b011fdbd4ad7d1e6f9762be4d1a88dffde614a6bd399bf3b5bad8f41249b5808080808080a06804caacbd199650c56afd63e3f3c730c2d3fb43f429819398af8e7d12f66e5980";
        bridgeRootProof[1] =
            hex"f843a033f7a9fe364faab93b216da50a3214154f22a0a2b415b23a84c8169e8b636ee3a1a02a6bdefe81a8e9d36fb1a8f8fb0b3e6e5fb45aa05b8542441a4c552b51e13fa7";

        client.processBridgeRootPublic(accountProof, epochProof, bridgeRootProof);

        assertEq(client.getFinalizedBridgeRoot(1), 0x2a6bdefe81a8e9d36fb1a8f8fb0b3e6e5fb45aa05b8542441a4c552b51e13fa7);
    }

    function test_bridgeRootProofFail() public {
        bytes32 stateRoot = 0x6cad1267b11a0388647c38a9736b7d582f86d73ec4429a00da41ae2ba26a90f5;
        lightClient.set_merkle_root(stateRoot);

        bytes[] memory accountProof = new bytes[](1);
        accountProof[0] =
            hex"f8669d3b673e571fbd6665e87cf8fcba9fb5ed2dcaba58ab6ccf9542818163bbb846f8440180a08aa1155cba880c632d39005ac99902ef3c058f1f78e211654f597e8f5082583ea0f96223f375264fd32d76bb95755f6bd4ee7efe35fbf2daeaa2b76c3421df08ee";

        bytes[] memory storageProof = new bytes[](1);
        storageProof[0] =
            hex"f844a120290decd9548b62a8d60345a988386fc84ba6bc95484008f6362f93160ef3e563a1a02a6bdefe81a8e9d36fb1a8f8fb0b3e6e5fb45aa05b8542441a4c552b51e13fa7";

        vm.expectRevert("MerkleTrie: invalid root hash");
        client.processBridgeRootPublic(accountProof, storageProof, storageProof);
    }
}
